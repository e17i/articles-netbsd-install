<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-04-27 Mo. 19:39 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Installation of NetBSD on a Mac Mini</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jörg Kollmann" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="rethink.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Installation of NetBSD on a Mac Mini</h1>

<div id="outline-container-orgcf4e259" class="outline-2">
<h2 id="orgcf4e259">What's the problem?</h2>
<div class="outline-text-2" id="text-orgcf4e259">
<p>
Over the easter days I was planning to resurrect my trusty ppc based Mac Mini and
to replace the old OSX 10.4 with a newer, but still BSD-based operating system.
The first try was to install OpenBSD, which went quite smoothly and without
great hassles. Fine.
</p>

<p>
But, as I made my first steps into the unix land many years ago using NetBSD
on my m68k based Amiga, I was eager to also have a look at the current NetBSD
versions. Phew, that was one kind of a ride! There are a few obstacles to
overcome when trying to install NetBSD/macppc on a Mac Mini, which made me
learn a lot of new details about that hardware and about the boot process. So
I thought I'd write a little bit about my experiences in case someone else
(probably me) ever tries to install this combination again.
</p>
</div>
</div>

<div id="outline-container-org907b6bb" class="outline-2">
<h2 id="org907b6bb">Overview</h2>
<div class="outline-text-2" id="text-org907b6bb">
<p>
When installing a current NetBSD into an intel based vm, the <code>sysinst</code> tool covers
the installation process quite well. The reasons why this doesn't work so well
on the ppc based Mac Mini (and also the solutions or at least some workarounds) can all
be found in the extensive installation document. But as it is rather long, covering a
range of different systems, it is quite a challenge to extract the
needed information&#x2014;each time hitting a problem you have to re-read large
portions until you find the missing detail. The four major points for me were:
</p>

<ul class="org-ul">
<li>The system is not able to boot directly off the bsd root file
system. This means you need at least a small mac hfs-formatted
partition to place the bootloader in. This is not done
automatically and the <code>hfsutils</code>, needed to access such a fs, are
not part of the base system.</li>
<li>When partitioning and formatting the disk, the <code>sysinst</code> tool generates
bsd disklabels while the Mac Mini firmware (Open Firmware 3.0) needs an
apple <code>pdisk</code>-style partition table. OpenBSD apparently overcomes this by
using just two basic <code>pdisk</code> partitions&#x2014;a small boot partition and the rest, which is
then partitioned using bsd disklabels. NetBSD for macppc seemingly needs all partitions to be
<code>pdisk</code> partitions, which means you have to leave out the partitioning stage
of <code>sysinst</code> and instead manually partition your disk (and manually generate an
adjacent <code>/etc/fstab</code>).</li>
<li>When doing the first reboot after installing the base sets, you'll find that
the bootloader, <code>ofwboot.xcf</code>, which is able to boot a Mac Mini from CD,
panics. Instead you need to use <code>ofwboot.elf</code>, which is hidden on the
installation cd in some subdirectory.</li>
<li>Finally, your system boots, but stays with a white screen. This is because
NetBSD on the Mac Mini doesn't know to activate the screen console. So you
need to configure an Open Firmware boot command writing something on the
screen before loading the boot program, this way activating the
console.
(This also seems to occur when quitting a running X11 server..)</li>
</ul>
</div>
</div>

<div id="outline-container-orgf70f858" class="outline-2">
<h2 id="orgf70f858">Step by step</h2>
<div class="outline-text-2" id="text-orgf70f858">
<p>
When you still have an osx/ppc install cd, first use that to partition your disk,
saving you some steps. On my 100GB disk, I created four partitions: a 4 MB hfs
boot partition, a large Apple/UX main partition and two small (16 and 5 GB)
partitions for swap and tmp. Also, use that chance to copy over both
<code>ofwboot.*</code> files and the <code>netbsd.macppc</code> installation kernel to the
hfs boot partition. Then you can skip a few steps, being able to
directly boot from disk (and later on have a recovery partition at
hand). From there, you can also install the sets downloading them on
the fly via HTTP, so you don't need to burn a cd.
</p>

<p>
In the following, I assume you don't have a mac osx installation cd at
hand.
</p>
</div>

<div id="outline-container-org396d86d" class="outline-3">
<h3 id="org396d86d">Download a NetBSD/macppc install iso and burn it to a cd.</h3>
<div class="outline-text-3" id="text-org396d86d">
<p>
When in an adventurous mood, instead set up a net boot facility on another
computer..
</p>
</div>
</div>

<div id="outline-container-orgf982dbc" class="outline-3">
<h3 id="orgf982dbc">Reboot, going into the firmware.</h3>
<div class="outline-text-3" id="text-orgf982dbc">
<p>
Hold down <code>CMD/OPT/O/F</code> keys while starting.
This brings you to the Open Firmware prompt.
</p>
</div>
</div>

<div id="outline-container-orgd758b33" class="outline-3">
<h3 id="orgd758b33">For the next steps, configure the system to always boot into ofw.</h3>
<div class="outline-text-3" id="text-orgd758b33">
<div class="org-src-container">
<pre class="src src-screen">setenv auto-boot? false
reset-all
</pre>
</div>

<p>
The second command saves the environment changes made by <code>setenv</code> and
restarts, which should bring you again to the Open Firmware prompt.
</p>

<p>
Some other useful commands at this prompt:
</p>
<div class="org-src-container">
<pre class="src src-screen">printenv
dir cd:,\macppc
devalias
</pre>
</div>
<p>
They show the current configuration and list the contents of some Open
Firmware accessable directory. So you can make sure you have the correct paths
in your configuration.
The third one can be used to define alternate boot procedures,
probably useful for update/recovery.
</p>
</div>
</div>

<div id="outline-container-orgcd2a8a5" class="outline-3">
<h3 id="orgcd2a8a5">Insert Install CD and boot.</h3>
<div class="outline-text-3" id="text-orgcd2a8a5">
<div class="org-src-container">
<pre class="src src-screen">boot cd:,\ofwboot.xcf netbsd.macppc
</pre>
</div>

<p>
Whenever you want to restart from the install cd, use this command.
The Installation CD uses a special kernel containing a ram disk with a minimal
NetBSD root partition, containing some basic system commands.
Nevertheless, it is a self-contained NetBSD system which can be started
without modifying the disk. At times, this may come in handy.
</p>

<p>
After booting, you can select to start <code>sysinst</code>, the system installer, or to
drop into a shell. Select <b>Install</b>.
You may choose the <b>Utility menu</b> and
<b>Configure network</b>. Later on, this is useful to install <code>pkgsrc</code>.
</p>
</div>
</div>

<div id="outline-container-org2180304" class="outline-3">
<h3 id="org2180304">Partition your disk.</h3>
<div class="outline-text-3" id="text-org2180304">
<p>
Go to the <b>Utility menu</b> and <b>Run /bin/sh</b>, then call <b>pdisk</b>.
</p>

<div class="org-src-container">
<pre class="src src-screen">pdisk /dev/rwd0c
</pre>
</div>

<p>
Using <code>p</code>, you can print the current map and <code>?</code> for help on further commands.
Create the partitions you want to use. The first partition should be your HFS
type boot partition. You should probably make it large enough to also put in
the installation kernel. It is around 3 MB in size, so I'd advice to take
minimally 4 MB for it. 
My partition table looks like this:
</p>

<pre class="example">
#:                type name     length   base      ( size )
1: Apple_partition_map Apple        63 @ 1
2:           Apple_HFS boot       2048 @ 64        (  1.0M)
3:     Apple_UNIX_SVR2 root  188743680 @ 2112      ( 90.0G) S0 RUFS k0  /
4:     Apple_UNIX_SVR2 swap   33554432 @ 188745792 ( 16.0G) S1  SFS k0  (swap)
5:     Apple_UNIX_SVR2 tmp    12141424 @ 222300224 (  5.8G) S2  UFS k0
</pre>

<p>
Here you are at the point of no return. Write the partition map using <code>w</code> and
quit <code>pdisk</code>. Now you can use <code>disklabel wd0</code> to find out the identifiers of the
new partitions.
</p>
</div>
</div>

<div id="outline-container-orga3a46e7" class="outline-3">
<h3 id="orga3a46e7">Format the root and tmp partition.</h3>
<div class="outline-text-3" id="text-orga3a46e7">
<div class="org-src-container">
<pre class="src src-screen">newfs /dev/rwd0a
newfs /dev/rwd0g
</pre>
</div>

<p>
The swap partition need not be formatted. If you create other partitions,
format them accordingly.
</p>
</div>
</div>

<div id="outline-container-orgbc414a2" class="outline-3">
<h3 id="orgbc414a2">Mount it and write /etc/fstab</h3>
<div class="outline-text-3" id="text-orgbc414a2">
<div class="org-src-container">
<pre class="src src-screen">mount /dev/wd0a /mnt
</pre>
</div>

<p>
The installation manual now suggests to write the <code>fstab</code> file using <code>cat</code>.
The downside of this is, after making a mistake, you can start all over again. But
actually there is an editor on board of the installation ram disk: <code>ed(1)</code>,
the standard text editor ;-)
</p>

<p>
If you know to use <code>vi</code> and also its command facility, you probably also will
be able to use <code>ed</code>. When making a mistake, you can substitute it (or just
replace that line), without needing to start all over again.
</p>

<div class="org-src-container">
<pre class="src src-screen">mkdir /mnt/etc
ed /mnt/etc/fstab
a
/dev/wd0a / ffs rw 1 1
/dev/wd0b none swap sw 0 0
/dev/wd0g /tmp ffs rw 1 2
<span style="color: #b0c4de;">.</span>
wq
</pre>
</div>

<p>
Later on, you may also put in lines for ptyfs, tmpfs etc.
Afterwards, unmount the disk and return to <code>sysinst</code>.
</p>

<div class="org-src-container">
<pre class="src src-screen">umount /mnt
<span style="color: #00ffff;">exit</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7d87f2d" class="outline-3">
<h3 id="org7d87f2d">Actually install the system.</h3>
<div class="outline-text-3" id="text-org7d87f2d">
<p>
When reaching this point, you made it behind most of the obstacles and now get
to a place where other NetBSD users comfortably have been led to by <code>sysinst</code>. Select
<b>Re-install or install additional sets</b> and now you can choose which sets you
want to install onto your new system. Then you may also configure first parts
of the system, as the installation manual suggests.
</p>
</div>
</div>

<div id="outline-container-org712efc8" class="outline-3">
<h3 id="org712efc8">Prepare the boot partition.</h3>
<div class="outline-text-3" id="text-org712efc8">
<p>
Now, once again, a small detour. The <code>hfsutils</code> must be built to format the
boot partition and to copy over the boot program. To do this, the system must
be booted, which can be done for now using the cd as bootstrapper. So exit and
reboot into the Open Firmware prompt, leaving the cd in.
</p>

<p>
Then, as mentioned above, the <code>elf</code> variant of <code>ofwboot</code> must be employed to
boot the disk.
</p>

<div class="org-src-container">
<pre class="src src-screen">boot cd:,\macppc\installation\ofwboot.elf hd:3,/netbsd
</pre>
</div>

<p>
The system boots into single user mode (you may need to press return to see
the prompt). Mount the root filesystem read-write:
</p>

<div class="org-src-container">
<pre class="src src-screen">mount -uw /
</pre>
</div>

<p>
If you didn't install <code>pkgsrc</code> before, call <code>sysinst</code> again, setup the network
configuration and use the menu to download and install <code>pkgsrc</code>. Then build
<code>hfsutils</code>:
</p>

<div class="org-src-container">
<pre class="src src-screen"><span style="color: #b0c4de;">cd</span> /usr/pkgsrc/sysutils/hfsutils
make
make install
make clean
</pre>
</div>

<p>
Then format the boot partition (see the output of <code>disklabel</code> above for the
id&#x2014;in my case it is <code>d</code>) and copy over the boot program from cd. If you have
enough space, also copy over the installation kernel:
</p>

<div class="org-src-container">
<pre class="src src-screen">hformat /dev/wd0d
mount /dev/cd0a /mnt
hcopy /mnt/macppc/installation/ofwboot.elf :
hcopy /mnt/netbsd.macppc :
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a35512" class="outline-3">
<h3 id="org3a35512">Setup Open Firmware for NetBSD boot.</h3>
<div class="outline-text-3" id="text-org3a35512">
<p>
Again, reboot into Open Firmware prompt. Now, you may also eject the cd.
The boot device and boot file can now be setup to use the boot loader on the
hfs partition and boot the kernel from root filesystem. Also, auto boot can be
reactivated. Last but not least, the screen console should be activated before
starting to boot.
</p>

<div class="org-src-container">
<pre class="src src-screen">setenv boot-device hd:2,ofwboot.elf
setenv boot-file hd:3,/netbsd
setenv auto-boot? true
setenv boot-command .<span style="color: #ffa07a;">" Booting NetBSD..."</span> cr <span style="color: #ffa07a;">" screen"</span> output boot
reset-all
</pre>
</div>

<p>
With the last command you made it! The system now reboots into NetBSD solely
from disk. You may again call <code>sysinst</code> to install further sets, and you
should follow the post installation steps of the installation guide.
</p>
</div>
</div>
</div>

<div id="outline-container-org67c762b" class="outline-2">
<h2 id="org67c762b">Finally</h2>
<div class="outline-text-2" id="text-org67c762b">
<p>
At least for me, quite a few iterations were needed to get here. Nevertheless,
having NetBSD finally running again on real hardware feels a little bit like
coming home after a long time.
<img src="./netbsd.png" alt="netbsd.png" />
</p>

<p>
On the NetBSD mailing lists other fancy modes of installation are
discussed, including writing a small cd image containing the boot
programs and then dumping it directly onto the harddisks first
sectors. While this may be a way of performing a more automated
installation, it doesn't seem to be a convenient way for now.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Jörg Kollmann
(Reddit: <a href="https://www.reddit.com/user/e17i">u/e17i</a>)</p><p>Made on
emacs org-mode with <a href="https://jessekelly881-rethink.surge.sh/">Rethink</a></p>
</div>
</body>
</html>
